trigger:
  branches:
    include:
    - master
resources:
  repositories:
  - repository: self
    type: git
    ref: master
jobs:
- job: Job_1
  displayName: Agent job 1
  pool:
    vmImage: ubuntu-18.04
  steps:
  - checkout: self
  - task: UseRubyVersion@0
    displayName: Use Ruby >= 2.2 <2.6
    inputs:
      versionSpec: '>= 2.2 <2.6'
  - task: WhiteSource@21
    displayName: WhiteSource
    inputs:
      projectName: 123whitesource
  - task: SonarCloudPrepare@1
    displayName: Prepare analysis on SonarCloud
    inputs:
      SonarCloud: 9a152823-7c6f-4aa8-a290-3457e881b67a
      organization: isaacteh
      scannerMode: CLI
      configMode: manual
      cliProjectKey: chili
      cliProjectName: chili
  - task: SonarCloudAnalyze@1
    displayName: Run Code Analysis
  - task: SonarCloudPublish@1
    displayName: Publish Quality Gate Result
  - task: sonarcloud-buildbreaker@2
    inputs:
      SonarCloud: 'SwiftSight'
      organization: 'isaacteh'
    enabled: false          
  - task: Bash@3
    displayName: Bash Script
    inputs:
      targetType: inline
      script: >-
        gem install jekyll

        gem install bundler:1.16.6

        bundle install --retry=3 --jobs=4

        bundle exec jekyll b
  - task: DockerInstaller@0
    inputs:
      dockerVersion: '17.09.0-ce'
  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: 'docker run --rm --volume="$PWD/drop:/usr/local/apache2/htdocs" -p 8080:80 -dit httpd:2.4'
  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: |
        ls -lrt
        pwd
        chmod -R 777  ./
        docker run --rm -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-full-scan.py -t http://172.17.0.1:8080 -g gen.conf -x OWASP-ZAP-Report.xml -r scan-report.html
        true
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        $XslPath = "$($Env:SYSTEM_DEFAULTWORKINGDIRECTORY)/_Digital-Cloud-Team-Singapore.mlaw-template/drop/OWASPToNUnit3.xslt"
        $XmlInputPath = "$($Env:SYSTEM_DEFAULTWORKINGDIRECTORY)/OWASP-ZAP-Report.xml"
        $XmlOutputPath = "$($Env:SYSTEM_DEFAULTWORKINGDIRECTORY)/Converted-OWASP-ZAP-Report.xml"
        $XslTransform = New-Object System.Xml.Xsl.XslCompiledTransform
        $XslTransform.Load($XslPath)
        $XslTransform.Transform($XmlInputPath, $XmlOutputPath)
  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      SourceFolder: _site
      TargetFolder: $(Build.ArtifactStagingDirectory)
  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      SourceFolder: test
      TargetFolder: $(Build.ArtifactStagingDirectory)      
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: drop'
...
